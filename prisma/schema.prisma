generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
}

model Room {
  id           String      @id @default(cuid())
  roomNumber   String
  status       RoomStatus
  maxOccupants Int

  tenants      Tenant[]
  invoices     Invoice[]
  contracts    Contract[]
  occupancyEvents OccupancyEvent[]
  tickets      Ticket[]
}

model Tenant {
  id      String  @id @default(cuid())
  name    String
  phone   String?
  role    String
  roomId  String
  room    Room    @relation(fields: [roomId], references: [id])

  invoices Invoice[]
  contracts Contract[]
  occupancyEvents OccupancyEvent[]
  tickets   Ticket[]
}

model Invoice {
  id           String   @id @default(cuid())
  roomId       String
  tenantId     String
  contractId   String?
  periodMonth  String
  rentAmount   Int
  waterAmount  Int      @default(0)
  electricAmount Int    @default(0)
  totalAmount  Int
  status       String   @default("UNPAID")
  issuedAt     DateTime @default(now())
  dueDate      DateTime
  paidAt       DateTime?
  ownerType    OwnerType @default(TENANT)

  room         Room     @relation(fields: [roomId], references: [id])
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  contract     Contract? @relation(fields: [contractId], references: [id])
  payments     Payment[]
}

enum OwnerType {
  TENANT
  CONTRACT
}

model Payment {
  id         String   @id @default(cuid())
  invoiceId  String
  amount     Int
  method     String
  reference  String?
  paidAt     DateTime

  invoice    Invoice  @relation(fields: [invoiceId], references: [id])
}

enum OccupancyEventType {
  MOVE_IN
  MOVE_OUT
}

enum OccupancySource {
  SYSTEM
  IMPORT
  BACKFILL
}

model OccupancyEvent {
  id        String   @id @default(cuid())
  roomId    String
  tenantId  String?
  type      OccupancyEventType
  eventAt   DateTime
  source    OccupancySource
  createdAt DateTime @default(now())

  room      Room     @relation(fields: [roomId], references: [id])
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([roomId, eventAt])
}

enum ContractStatus {
  DRAFT
  ACTIVE
  TERMINATED
  EXPIRED
}

model Contract {
  id        String   @id @default(cuid())
  tenantId  String
  roomId    String
  startDate DateTime
  endDate   DateTime?
  rent      Int
  deposit   Int?
  status    ContractStatus
  createdAt DateTime @default(now())

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  room     Room   @relation(fields: [roomId], references: [id])
  invoices Invoice[]
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum TicketSource {
  LINE
}

model Ticket {
  id                String        @id @default(cuid())
  source            TicketSource
  externalThreadId  String
  tenantId          String?
  roomId            String?
  title             String
  status            TicketStatus
  createdAt         DateTime      @default(now())
  closedAt          DateTime?

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  room   Room?   @relation(fields: [roomId], references: [id])

  messages TicketMessage[]
  outboxes TicketOutbox[]
  @@index([externalThreadId])
}

model AuditEvent {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())

  actorType  String
  actorId    String?

  action     String
  targetType String
  targetId   String?

  severity   String
  metadata   Json?
  before     Json?
  after      Json?

  @@index([timestamp])
  @@index([actorType, actorId])
  @@index([targetType, targetId])
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageChannel {
  LINE
}

model TicketMessage {
  id           String           @id @default(cuid())
  ticketId     String
  direction    MessageDirection
  channel      MessageChannel
  messageText  String
  createdAt    DateTime         @default(now())

  ticket       Ticket           @relation(fields: [ticketId], references: [id])

  @@index([ticketId, createdAt])
}

enum OutboxStatus {
  PENDING
  SENT
  FAILED
}

model TicketOutbox {
  id         String        @id @default(cuid())
  ticketId   String
  channel    MessageChannel
  payload    Json
  status     OutboxStatus
  createdAt  DateTime      @default(now())
  sentAt     DateTime?
  errorMessage String?
  retryCount   Int          @default(0)
  nextRetryAt  DateTime?

  ticket     Ticket        @relation(fields: [ticketId], references: [id])

  @@index([ticketId, status, createdAt])
  @@index([status, nextRetryAt])
}
