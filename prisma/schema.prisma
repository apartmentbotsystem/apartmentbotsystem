generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
}

model Room {
  id           String      @id @default(cuid())
  roomNumber   String
  status       RoomStatus
  maxOccupants Int

  tenantId     String?     @unique
  tenant       Tenant?     @relation("RoomTenant", fields: [tenantId], references: [id])
  tenants      Tenant[]    @relation("TenantRoom")
  invoices     Invoice[]
  contracts    Contract[]
  occupancyEvents OccupancyEvent[]
  tickets      Ticket[]
  registrations TenantRegistration[]
}

model Tenant {
  id      String  @id @default(cuid())
  name    String
  phone   String?
  lineUserId String? @unique
  role    String
  roomId  String?
  room    Room?   @relation("TenantRoom", fields: [roomId], references: [id])
  assignedRoom Room? @relation("RoomTenant")

  invoices Invoice[]
  contracts Contract[]
  occupancyEvents OccupancyEvent[]
  tickets   Ticket[]
  registrations TenantRegistration[]

  @@unique([roomId])
}

model Invoice {
  id           String   @id @default(cuid())
  roomId       String
  tenantId     String
  contractId   String?
  periodMonth  String
  rentAmount   Int
  waterAmount  Int      @default(0)
  electricAmount Int    @default(0)
  totalAmount  Int
  status       InvoiceStatus @default(DRAFT)
  issuedAt     DateTime @default(now())
  sentAt       DateTime?
  dueDate      DateTime
  paidAt       DateTime?
  paymentNote  String?
  ownerType    OwnerType @default(TENANT)

  room         Room     @relation(fields: [roomId], references: [id])
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  contract     Contract? @relation(fields: [contractId], references: [id])
  payments     Payment[]
}

enum OwnerType {
  TENANT
  CONTRACT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

model Payment {
  id         String   @id @default(cuid())
  invoiceId  String
  amount     Int
  method     String
  reference  String?
  paidAt     DateTime

  invoice    Invoice  @relation(fields: [invoiceId], references: [id])
}

enum OccupancyEventType {
  MOVE_IN
  MOVE_OUT
}

enum OccupancySource {
  SYSTEM
  IMPORT
  BACKFILL
}

model OccupancyEvent {
  id        String   @id @default(cuid())
  roomId    String
  tenantId  String?
  type      OccupancyEventType
  eventAt   DateTime
  source    OccupancySource
  createdAt DateTime @default(now())

  room      Room     @relation(fields: [roomId], references: [id])
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([roomId, eventAt])
}

enum TenantRegistrationStatus {
  PENDING
  ACTIVE
  REJECTED
}

model TenantRegistration {
  id          String                   @id @default(cuid())
  lineUserId  String
  roomId      String?
  status      TenantRegistrationStatus  @default(PENDING)
  createdAt   DateTime                  @default(now())
  approvedAt  DateTime?
  approvedBy  String?
  tenantId    String?

  room    Room?    @relation(fields: [roomId], references: [id])
  tenant  Tenant?  @relation(fields: [tenantId], references: [id])

  @@unique([lineUserId])
}

enum ContractStatus {
  DRAFT
  ACTIVE
  TERMINATED
  EXPIRED
}

model Contract {
  id        String   @id @default(cuid())
  tenantId  String
  roomId    String
  startDate DateTime
  endDate   DateTime?
  rent      Int
  deposit   Int?
  status    ContractStatus
  createdAt DateTime @default(now())

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  room     Room   @relation(fields: [roomId], references: [id])
  invoices Invoice[]
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum TicketSource {
  LINE
}

model Ticket {
  id                String        @id @default(cuid())
  source            TicketSource
  externalThreadId  String
  tenantId          String?
  roomId            String?
  title             String
  status            TicketStatus
  createdAt         DateTime      @default(now())
  closedAt          DateTime?

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  room   Room?   @relation(fields: [roomId], references: [id])

  messages TicketMessage[]
  outboxes TicketOutbox[]
  @@index([externalThreadId])
}

model AuditEvent {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())

  actorType  String
  actorId    String?

  action     String
  targetType String
  targetId   String?

  severity   String
  metadata   Json?
  before     Json?
  after      Json?

  @@index([timestamp])
  @@index([actorType, actorId])
  @@index([targetType, targetId])
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageChannel {
  LINE
}

model TicketMessage {
  id           String           @id @default(cuid())
  ticketId     String
  direction    MessageDirection
  channel      MessageChannel
  messageText  String
  createdAt    DateTime         @default(now())

  ticket       Ticket           @relation(fields: [ticketId], references: [id])

  @@index([ticketId, createdAt])
}

enum OutboxStatus {
  PENDING
  SENT
  FAILED
}

model TicketOutbox {
  id         String        @id @default(cuid())
  ticketId   String
  channel    MessageChannel
  payload    Json
  status     OutboxStatus
  createdAt  DateTime      @default(now())
  sentAt     DateTime?
  errorMessage String?
  retryCount   Int          @default(0)
  nextRetryAt  DateTime?

  ticket     Ticket        @relation(fields: [ticketId], references: [id])

  @@index([ticketId, status, createdAt])
  @@index([status, nextRetryAt])
}

enum AdminAuditAction {
  TENANT_REGISTRATION_APPROVE
  TENANT_REGISTRATION_REJECT
  TENANT_ASSIGN_ROOM
  TENANT_VACATE
  BILLING_GENERATE
  INVOICE_SENT
  INVOICE_PAID
}

model AdminAuditLog {
  id                    String            @id @default(cuid())
  action                AdminAuditAction
  adminId               String
  tenantRegistrationId  String
  tenantId              String?
  lineUserId            String?
  createdAt             DateTime          @default(now())
}

model IdempotencyKey {
  id               String   @id @default(cuid())
  key              String
  endpoint         String
  requestHash      String
  responseSnapshot Json
  createdAt        DateTime @default(now())

  @@unique([key, endpoint])
}

enum AutomationDecision {
  APPROVED
  REJECTED
}

model AutomationApproval {
  id               String              @id @default(cuid())
  proposalId       String              @unique
  decision         AutomationDecision
  decidedBy        String
  decidedAt        DateTime            @default(now())
  note             String?
  proposalSnapshot Json
  proposalHash     String
  executedAt       DateTime?
  executeResult    Json?
  createdAt        DateTime            @default(now())
}

enum AutomationAuditAction {
  PREVIEW
  EXECUTE
  SKIP
  FAIL
  AUTO_APPROVED
  AUTO_EXECUTED
}

model AutomationAudit {
  id          String                 @id @default(cuid())
  approvalId  String
  proposalId  String
  action      AutomationAuditAction
  actorId     String
  dryRun      Boolean
  result      Json
  createdAt   DateTime               @default(now())

  @@index([approvalId, createdAt])
  @@index([proposalId, createdAt])
}

enum AutomationProposalType {
  REMIND_INVOICE
  ESCALATE_TICKET
}

enum AutomationMaxSeverity {
  LOW
  MEDIUM
}

model AutomationPolicy {
  id            String                @id @default(cuid())
  proposalType  AutomationProposalType
  maxSeverity   AutomationMaxSeverity
  autoApprove   Boolean
  autoExecute   Boolean
  dailyLimit    Int
  enabled       Boolean               @default(false)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
}
